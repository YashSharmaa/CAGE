# CAGE Sandbox Container Image for Julia
# Secure Julia execution environment for scientific computing

FROM julia:1.10-bookworm AS runtime

# Security: Create non-root user
RUN (groupadd --gid 1000 sandbox 2>/dev/null || true) && \
    (useradd --uid 1000 --gid 1000 --shell /bin/bash --create-home sandbox 2>/dev/null || true)

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core utilities
    coreutils \
    procps \
    bash \
    # Julia package dependencies
    build-essential \
    git \
    && rm -rf /var/lib/apt/lists/* \
    # Security: Remove package managers after installation
    && rm -f /usr/bin/apt* /usr/bin/dpkg* \
    && rm -f /usr/bin/wget /usr/bin/curl 2>/dev/null || true

# Pre-install common Julia packages as sandbox user
USER sandbox
RUN julia -e 'using Pkg; Pkg.add(["JSON"]); Pkg.precompile()'

# Create working directory
USER root
RUN mkdir -p /mnt/data && chown sandbox:sandbox /mnt/data

# Switch back to non-root user
USER sandbox
WORKDIR /mnt/data

# Security: Set restrictive umask
ENV UMASK=0077

# Set Julia depot path to be in user directory
ENV JULIA_DEPOT_PATH="/home/sandbox/.julia"

# Default command - idle process
CMD ["sleep", "infinity"]

# Labels
LABEL org.opencontainers.image.title="CAGE Julia Sandbox"
LABEL org.opencontainers.image.description="Secure Julia sandbox for LLM code execution"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.vendor="CAGE Project"
