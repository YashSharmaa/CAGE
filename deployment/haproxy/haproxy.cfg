# HAProxy Configuration for CAGE Multi-Node Load Balancing
#
# Features:
# - Round-robin load balancing across orchestrator nodes
# - Health checks every 5 seconds
# - Session stickiness via cookie
# - TLS termination
# - Rate limiting headers

global
    log stdout format raw local0 info
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

frontend cage_frontend
    bind *:443 ssl crt /etc/haproxy/certs/cage.pem
    bind *:80

    # Redirect HTTP to HTTPS
    http-request redirect scheme https code 301 if !{ ssl_fc }

    # Add security headers
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"

    # Default backend
    default_backend cage_orchestrators

backend cage_orchestrators
    balance roundrobin
    option httpchk GET /health HTTP/1.1\r\nHost:\ cage.example.com
    http-check expect status 200

    # Session stickiness - same user goes to same orchestrator
    cookie CAGE_NODE insert indirect nocache httponly secure

    # Orchestrator nodes
    server cage-node1 192.168.1.10:8080 check inter 5s fall 3 rise 2 cookie node1
    server cage-node2 192.168.1.11:8080 check inter 5s fall 3 rise 2 cookie node2
    server cage-node3 192.168.1.12:8080 check inter 5s fall 3 rise 2 cookie node3

    # Connection limits
    maxconn 2000

# Stats page (optional)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:change_this_password
